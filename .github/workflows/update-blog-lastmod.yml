name: Update blog index last_modified_at

on:
  push:
    branches: [ main ]
    paths:
      - "_posts/**"

permissions:
  contents: write

jobs:
  update:
    # Prevent infinite loops from bot commits
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute latest post date from filenames
        id: latest
        shell: bash
        run: |
          latest=$(ls -1 _posts/*.md _posts/*.markdown 2>/dev/null \
            | sed -E 's#.*/([0-9]{4}-[0-9]{2}-[0-9]{2})-.*#\1#' \
            | sort | tail -n 1)

          if [ -z "$latest" ]; then
            echo "No markdown posts found in _posts/. Skipping."
            exit 0
          fi

          echo "latest=$latest" >> "$GITHUB_OUTPUT"

      - name: Update blog.md last_modified_at
        shell: bash
        run: |
          latest="${{ steps.latest.outputs.latest }}"
          echo "Setting blog.md last_modified_at to $latest"
          sed -i -E "s/^last_modified_at: .*/last_modified_at: ${latest}/" blog.md

      - name: Commit and push if changed
        shell: bash
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add blog.md
          git commit -m "chore(blog): update blog index last_modified_at"
          git push
