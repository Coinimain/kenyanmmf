name: Build sitemap

on:
  push:
    branches: [ main, gh-pages ]
    # Only run when site content or the generator changes (not when sitemap files change)
    paths:
      - "**/*.html"
      - "robots.txt"
      - "scripts/generate_sitemap.py"
      - ".github/workflows/sitemap.yml"
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"  # daily

permissions:
  contents: write

jobs:
  generate:
    # Skip if the pusher is the bot committing the sitemap
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate sitemaps
        run: |
          python scripts/generate_sitemap.py

      - name: Commit sitemap updates
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            sitemap.xml
            sitemap.xml.gz
            sitemap_index.xml
            robots.txt
          message: "chore(sitemap): auto-update sitemap & index"
          default_author: github_actions
