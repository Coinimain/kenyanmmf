name: Google Sitemap Ping Posts New and Edited

"on":
  push:
    branches:
      - main
    paths:
      - "_posts/**"
  workflow_dispatch:

jobs:
  ping-google:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed posts (new + edited)
        id: detect
        run: |
          set -e
          echo "Checking for changed posts (added or modified) in the last push..."

          CHANGED_POSTS=$(git diff --name-status "${{ github.event.before }}" "${{ github.sha }}" 2>/dev/null \
            | awk '($1=="A" || $1=="M") && $2 ~ /^_posts\// {print $2}' || true)

          if [ -z "$CHANGED_POSTS" ]; then
            echo "No post changes detected."
            echo "posts_changed=false" >> $GITHUB_OUTPUT
          else
            echo "Post change(s) detected:"
            echo "$CHANGED_POSTS"

            echo "posts_changed=true" >> $GITHUB_OUTPUT
            echo "post_list<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_POSTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Ping Google Sitemap
        if: steps.detect.outputs.posts_changed == 'true'
        run: |
          SITEMAP_URL="https://kenyammfcalculator.co.ke/sitemap.xml"
          PING_URL="https://www.google.com/ping?sitemap=${SITEMAP_URL}"

          echo "Pinging Google sitemap because these post(s) changed:"
          echo "${{ steps.detect.outputs.post_list }}"
          echo ""
          echo "Sitemap: $SITEMAP_URL"
          echo ""

          http_code=$(curl -s -o /dev/null -w "%{http_code}" "$PING_URL")
          echo "Google ping HTTP status: $http_code"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "✅ Google sitemap ping sent successfully"
          else
            echo "⚠️ Google ping returned non-OK status: $http_code"
            exit 1
          fi