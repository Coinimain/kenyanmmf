name: IndexNow Submit

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  indexnow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Submit changed pages to IndexNow
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          set -e

          echo "Detecting changed files in the last commit..."
          changed=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E '\.html$|sitemap.*\.xml(\.gz)?$' || true)

          declare -a urls=()

          if [ -n "$changed" ]; then
            echo "Changed files:"
            echo "$changed"
            echo ""

            while IFS= read -r f; do
              # strip leading ./ if present
              path="${f#./}"

              # Skip partials/includes (safety)
              case "$path" in
                footer.html|header.html|nav.html) continue;;
              esac

              # If docs/ is your site root, adjust here
              if [[ "$path" == docs/* ]]; then
                path="${path#docs/}"
              fi

              urls+=("https://kenyammfcalculator.co.ke/${path}")
            done <<< "$changed"
          else
            echo "No matching changed HTML/sitemap files detected."
          fi

          # Always include homepage and privacy as safety
          urls+=("https://kenyammfcalculator.co.ke/" "https://kenyammfcalculator.co.ke/privacy.html")

          # De-dupe URLs (preserve order)
          deduped=()
          for u in "${urls[@]}"; do
            if [[ ! " ${deduped[*]} " =~ " ${u} " ]]; then
              deduped+=("$u")
            fi
          done
          urls=("${deduped[@]}")

          echo "Submitting ${#urls[@]} unique URL(s) to IndexNow:"
          printf '%s\n' "${urls[@]}"
          echo ""

          for url in "${urls[@]}"; do
            echo "Submitting: $url"
            encoded_url=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$url''', safe=''))")
            curl -s -D- "https://www.bing.com/indexnow?url=${encoded_url}&key=${INDEXNOW_KEY}" -o /dev/null
            echo ""
          done
